<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ü§ñ RAG ChatBot: Multi-file and LLM Integration </title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        /* Ensure the body and html take full height */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Container occupies full viewport height */
        .container-full {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Main content row occupies remaining space */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Left and Right columns */
        .left-column, .right-column {
            padding: 15px;
            overflow-y: auto;
        }

        .left-column {
            width: 40%;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }

        .right-column {
            width: 60%;
            display: flex;
            flex-direction: column;
        }

        /* Form and Preview sections */
        .form-section {
            flex: 1;
            margin-bottom: 15px;
        }

        .preview-section {
            flex: 1;
            overflow-y: auto;
        }

        /* Chat interface styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .chat-box {
            flex: 1;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
            background-color: #ffffff;
        }
        .chat-input {
            margin-top: 10px;
        }
        .chat-message {
            margin-bottom: 10px;
        }
        .chat-message.user {
            text-align: right;
        }
        .chat-message.user p {
            display: inline-block;
            background-color: #007bff;
            color: #fff;
            padding: 10px;
            border-radius: 15px;
        }
        .chat-message.bot p {
            display: inline-block;
            background-color: #f1f0f0;
            color: #000;
            padding: 10px;
            border-radius: 15px;
        }

        /* Loading indicator positioned in the center */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }

        /* Preview styles */
        .preview-container {
            margin-top: 10px;
        }
        .preview-item {
            margin-bottom: 15px;
        }
        .preview-item iframe, .preview-item embed, .preview-item audio {
            width: 100%;
            height: 300px;
        }
        .preview-item img {
            max-width: 100%;
            height: auto;
        }

        /* Dark mode styles */
        .dark-mode {
            background-color: #191e27;
            color: #f8f9fa;
        }
        .dark-mode .chat-box {
            background-color: #000000;
            color: #f8f9fa;
        }
        .dark-mode .preview-item iframe, .dark-mode .preview-item embed, .dark-mode .preview-item audio {
            background-color: #1e1e1e;
        }
    </style>
</head>
<body class="light-mode">
    <div class="container-full">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h1>ü§ñ WiseNeuron: RAG ChatBot Multi-file Integration</h1>
            <button id="toggleTheme" class="btn btn-secondary">
                <i class="fas fa-adjust"></i> üåó Toggle Dark Mode
            </button>
        </div>
        <p>Efficiently retrieve and generate answers using üìÑ PDFs, üìÑ Word files, üìÑ TXT files, üé• YouTube links, üé§ audio files, or üîó URLs</p>
        
        <div class="main-content">
            <!-- Left Column: RAG System Form and Preview -->
            <div class="left-column">
                <!-- Form Section -->
                <div class="form-section">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="rag-tab" data-toggle="tab" href="#rag" role="tab" aria-controls="rag" aria-selected="true" data-toggle="tooltip" title="RAG System Overview">
                                </i> ü§ñ RAG ChatBot
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="chat-tab" data-toggle="tab" href="#chat" role="tab" aria-controls="chat" aria-selected="false" data-toggle="tooltip" title="Chat with LLM">
                                <i class="fas fa-comments"></i>  Direct LLM Chat
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <!-- RAG System Tab -->
                        <div class="tab-pane fade show active" id="rag" role="tabpanel" aria-labelledby="rag-tab">
                            <form id="ragForm" method="post" enctype="multipart/form-data">
                                <div class="form-group mt-3">
                                    <label>Choose input type:</label>
                                    <div class="input-type">
                                        <label>
                                            <input type="radio" name="input_type" value="Word Files" />
                                            <span><i class="fas fa-file-word"></i> </span>
                                            Word Files
                                        </label>
                                        <label>
                                            <input type="radio" name="input_type" value="PDFs" />
                                            <span><i class="fas fa-file-pdf"></i> </span>
                                            PDFs
                                        </label>
                                        <label>
                                            <input type="radio" name="input_type" value="TXT Files" />
                                            <span><i class="fas fa-file-alt"></i> </span>
                                            TXT Files
                                        </label>
                                        <label>
                                            <input type="radio" name="input_type" value="YouTube Links" />
                                            <span><i class="fab fa-youtube"></i> </span>
                                            YouTube Links
                                        </label>
                                        <label>
                                            <input type="radio" name="input_type" value="Audio Files" />
                                            <span></i> üé§</span>
                                            Audio Files
                                        </label>
                                        <label>
                                            <input type="radio" name="input_type" value="URLs" />
                                            <span><i class="fas fa-link"></i> </span>
                                            URLs
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group" id="fileUpload" style="display: none">
                                    <label for="files">Upload files:</label>
                                    <input type="file" class="form-control-file" id="files" name="files" multiple />
                                </div>

                                <div class="form-group" id="urlInput" style="display: none">
                                    <label for="urls">Enter URLs (one per line):</label>
                                    <textarea class="form-control" id="urls" name="urls" rows="3"></textarea>
                                </div>

                                <div class="form-group" id="youtubeInput" style="display: none">
                                    <label for="youtube_urls">Enter YouTube URLs (one per line):</label>
                                    <textarea class="form-control" id="youtube_urls" name="youtube_urls" rows="3"></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary btn-block mt-3">
                                    üöÄ Process Documents
                                </button>
                            </form>
                        </div>

                        <!-- Direct LLM Chat Tab (Optional: You can remove this if integrating chat into the right column) -->
                        <!--
                        <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
                            <form id="chatForm" method="post">
                                <div class="form-group mt-4">
                                    <label for="message">Enter your message:</label>
                                    <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary btn-block">Send</button>
                            </form>

                            <div id="chatResponse" class="mt-4" style="display: none">
                                <h5>LLM Response:</h5>
                                <p id="response"></p>
                            </div>
                        </div>
                        -->
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="preview-section">

                    <div class="preview-container">
                        <h4>Preview: üëÄ</h4>
                        <div id="preview"></div>
                    </div>
                    </div>
                    </div>
                    
                    <!-- Right Column: Chat Interface -->
                    <div class="right-column">
                        <div class="chat-container">
                            <div class="chat-box" id="chatBox">
                                <!-- Chat messages will appear here -->
                            </div>
                            <form id="chatForm" class="chat-input">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="query" name="query" placeholder="Enter your query... ü§î" required />
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="submit">Send üöÄ</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div class="loading" id="loadingIndicator">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading... ‚è≥</span>
                        </div>
                        <span>Thinking... ü§ñ</span>
                    </div>
                    </div>
                    
                    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
                    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
                    <script>
                        $(document).ready(function () {
                            $('[data-toggle="tooltip"]').tooltip();
                    
                            // Dark mode toggle
                            $("#toggleTheme").on("click", function () {
                                $("body").toggleClass("dark-mode");
                                $("body").toggleClass("light-mode");
                                $(this).html($(this).html().includes("Dark") ? 
                                    '<i class="fas fa-sun"></i> Toggle Light Mode üåû' : 
                                    '<i class="fas fa-moon"></i> Toggle Dark Mode üåú');
                            });
                    
                            // Show/Hide input fields based on input type
                            $(".input-type input[type='radio']").on("change", function () {
                                var inputType = $(this).val();
                                if (inputType === "URLs") {
                                    $("#urlInput").show();
                                    $("#fileUpload").hide();
                                    $("#youtubeInput").hide();
                                } else if (inputType === "YouTube Links") {
                                    $("#youtubeInput").show();
                                    $("#fileUpload").hide();
                                    $("#urlInput").hide();
                                } else if (inputType === "Audio Files" || inputType === "PDFs" || inputType === "Word Files" || inputType === "TXT Files") {
                                    $("#fileUpload").show();
                                    $("#urlInput").hide();
                                    $("#youtubeInput").hide();
                                } else {
                                    $("#fileUpload").hide();
                                    $("#urlInput").hide();
                                    $("#youtubeInput").hide();
                                }
                                // Clear previous previews
                                $("#preview").empty();
                            });
                    
                            // Handle RAG Form Submission
                            $("#ragForm").on("submit", function (e) {
                                e.preventDefault();
                                $("#loadingIndicator").show();
                    
                                var formData = new FormData(this);
                    
                                $.ajax({
                                    url: "/process_documents",
                                    type: "POST",
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    success: function (response) {
                                        $("#loadingIndicator").hide();
                                        alert(response.message);
                                        // Optionally, you can clear the form or update the UI accordingly
                                    },
                                    error: function (xhr, status, error) {
                                        $("#loadingIndicator").hide();
                                        var errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : "An error occurred.";
                                        alert("Error: " + errorMsg);
                                    },
                                });
                            });
                    
                            // Handle Chat Form Submission
                            $("#chatForm").on("submit", function (e) {
                                e.preventDefault();
                                var query = $("#query").val().trim();
                                if (!query) {
                                    alert("Please enter a query. ‚ùó");
                                    return;
                                }
                    
                                // Append user's message to chat box
                                $("#chatBox").append(
                                    `<div class="chat-message user"><p>üë§ ${escapeHtml(query)}</p></div>`
                                );
                                $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
                    
                                $("#query").val('');
                                $("#loadingIndicator").show();
                    
                                $.ajax({
                                    url: "/answer_question",
                                    type: "POST",
                                    data: { query: query },
                                    success: function (response) {
                                        $("#loadingIndicator").hide();
                                        // Append bot's response to chat box
                                        var botResponse = response.answer || "No answer found. ü§∑";
                                        $("#chatBox").append(
                                            `<div class="chat-message bot"><p>ü§ñ ${escapeHtml(botResponse)}</p></div>`
                                        );
                                        $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
                                    },
                                    error: function (xhr, status, error) {
                                        $("#loadingIndicator").hide();
                                        var errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : "An error occurred.";
                                        $("#chatBox").append(
                                            `<div class="chat-message bot"><p>‚ùó ${escapeHtml(errorMessage)}</p></div>`
                                        );
                                        $("#chatBox").scrollTop($("#chatBox")[0].scrollHeight);
                                    },
                                });
                            });
                    
                            // Utility function to escape HTML to prevent XSS
                            function escapeHtml(text) {
                                return text
                                    .replace(/&/g, "&amp;")
                                    .replace(/</g, "&lt;")
                                    .replace(/>/g, "&gt;")
                                    .replace(/"/g, "&quot;")
                                    .replace(/'/g, "&#039;");
                            }
                    
                            // Preview functionality
                            function previewFiles(files, inputType) {
                                $("#preview").empty(); // Clear previous previews
                                Array.from(files).forEach(file => {
                                    var reader = new FileReader();
                                    var previewItem = $('<div class="preview-item"></div>');
                    
                                    if (inputType === "PDFs") {
                                        var objectURL = URL.createObjectURL(file);
                                        var embed = `<embed src="${objectURL}" type="application/pdf" width="100%" height="300px" /> üìë`;
                                        previewItem.html(embed);
                                        $("#preview").append(previewItem);
                                    } else if (inputType === "Audio Files") {
                                        var objectURL = URL.createObjectURL(file);
                                        var audio = `<audio controls src="${objectURL}"></audio> üéß`;
                                        previewItem.html(audio);
                                        $("#preview").append(previewItem);
                                    } else if (inputType === "Word Files" || inputType === "TXT Files") {
                                        reader.onload = function(e) {
                                            var content = e.target.result;
                                            var textPreview = `<pre>${escapeHtml(content.substring(0, 500))}...</pre> üìù`;
                                            previewItem.html(textPreview);
                                            $("#preview").append(previewItem);
                                        };
                                        reader.readAsText(file);
                                    }
                                });
                            }
                    
                            function previewYouTubeLinks(urls) {
                                $("#preview").empty(); // Clear previous previews
                                urls.forEach(url => {
                                    var videoId = extractVideoID(url);
                                    if (videoId) {
                                        var iframe = `<div class="preview-item"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe> üé•</div>`;
                                        $("#preview").append(iframe);
                                    } else {
                                        var errorMsg = `<div class="preview-item"><p>Invalid YouTube URL: ${escapeHtml(url)} ‚ùå</p></div>`;
                                        $("#preview").append(errorMsg);
                                    }
                                });
                            }
                    
                            function extractVideoID(url) {
                                var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                                var match = url.match(regExp);
                                if (match && match[2].length == 11) {
                                    return match[2];
                                } else {
                                    return null;
                                }
                            }
                    
                            // Handle file input changes for preview
                            $("#files").on("change", function () {
                                var inputType = $("input[name='input_type']:checked").val();
                                if (inputType) {
                                    previewFiles(this.files, inputType);
                                }
                            });
                    
                            // Handle URL and YouTube link inputs for preview
                            $("#urls").on("input", function () {
                                var inputType = $("input[name='input_type']:checked").val();
                                if (inputType === "URLs") {
                                    var urls = $(this).val().split('\n').filter(url => url.trim() !== '');
                                    $("#preview").empty();
                                    urls.forEach(url => {
                                        var sanitizedURL = escapeHtml(url);
                                        var link = `<p><a href="${sanitizedURL}" target="_blank">${sanitizedURL}</a> üîó</p>`;
                                        $("#preview").append(link);
                                    });
                                }
                            });
                    
                            $("#youtube_urls").on("input", function () {
                                var inputType = $("input[name='input_type']:checked").val();
                                if (inputType === "YouTube Links") {
                                    var youtubeUrls = $(this).val().split('\n').filter(url => url.trim() !== '');
                                    previewYouTubeLinks(youtubeUrls);
                                }
                            });
                    
                        });
                    </script>
                    </body>
                    </html>
                    